# Introduction

This repository contains the terraform modules for deploying AKS for use with BigBang installation.

# Getting Started
1. Tools required:
   * terraform
   * kubectl
   * Azure CLI  

2. Run deployment from example directory: `cd example`

3. Copy `terraform.tfvars.sample` to `terraform.tfvars`

4. Update variables:
     - `CLUSTER_NAME`: name of your AKS cluster
     - `RESOURCE_GROUP_NAME`: name of your AKS cluster
     - `AZUREAD_GROUP_IDS`: This AKS cluster uses managed identity. In order to connect to the cluster, a user must be a part of an AAD Group. This variable can be a comma separated list of Group Ids. If you don't have an AD Group, you can create one or connect with admin credentials (not recommended).


5. The networking defaults can be updated if required.

# Build
1. In the example directory, Initialize terraform: `terraform init`
2. Apply the terraform modules: `terraform apply`
3. Assuming the terraform apply completes successfully, you can know get the credentials to access the cluster:

   ```
   az aks get-credentials --resource-group {RESOURCE_GROUP_NAME} --name {CLUSTER_NAME}
   ```

# Installing BigBang with AKS
This repo includes a few scripts which can be used to facilitate the BigBang deployment following the
[BigBang Customer Template](https://repo1.dso.mil/platform-one/big-bang/customers/template).
## Generate wildcard certificate for your domain

A certificate for the domain in the key `domain` in dev/configmap.yaml is needed for the Istio gateway.

We can create a TLS secret for each gateway with the name `<name of gateway>-cert` for its secret.
Our example will create a `public` gateway and `public-cert` based on the values in `ISTIO_GW_CRT` and `ISTIO_GW_KEY` as created in the next step.

### Self signed certificate

A certificate for non-production environments can be generated by executing the following steps:
```bash
HOSTNAME=bigbang.dev
./scripts/create-root-cert.sh
./scripts/create-domain-cert.sh $HOSTNAME
ISTIO_GW_CRT=$(cat $HOSTNAME.crt | base64 -w0)
ISTIO_GW_KEY=$(cat $HOSTNAME.key | base64 -w0)
```

### Changing certificate

If your certificate was changed change the value in `secrets.sh` and `deploy-vars.sh` them execute `update-certs.sh`

## Automated deploy script
The repo also includes a script ([scripts/deploy.sh](deploy.sh)) with a fast automated way to deploy
BigBang into a cluster with a single bash script carrying out most of the repetitive tasks.


1. Copy `secrets.sh.sample` to `secrets.sh` and edit to with your own values and secrets as follows:
- Set IRON_BANK_USER & IRON_BANK_PAT with the Username and CLI secret from your User Profile on https://registry1.dso.mil (After logging in click your username in the upper righthand corner).
- Set AZDO_USER & AZDO_PASSWORD with your git credentials.
- Set ISTIO_GW_CRT & ISTIO_GW_KEY with the certificates from the step above.
2. Copy `deploy-vars.sh.sample` to `deploy-vars.sh` and configure as you wish

It is critical you get the values in these two files correct as they drive all the automation

If you want to deploy AKS as part of the deployment then set `DEPLOY_AKS="true"` by default it will not be deployed

Run the automated deployment script

```bash
cd scripts
./deploy.sh
```

This script will carry out the following:

1. One time creation of GPG keys and update to `.sops.yaml` if keys are found to exist, this step is skipped.
2. Creation/update of `secrets.enc.yaml` and pushed with git
3. _OPTIONAL: Deployment of AKS cluster._
4. _OPTIONAL: Connection to AKS cluster for kubectl etc_
5. Creation of namespaces: `bigbang` and `flux-system`
6. Creation of secrets: `sops-gpg`, `private-registry` & `private-git`
7. Deployment of Flux from the main bigbang repo which will be cloned and `scripts/install_flux.sh` run. This can be disabled by setting `DEPLOY_FLUX=false`.
8. Removes network policies which block Flux being scraped
9. Deploys the `dev/bigbang.yaml` to the cluster
10. Validates the status of the deployment

Run `kubectl get gitrepositories,ks,hr -A` to see the status of what was just deployed.

It will take between five and ten minutes for deployment to complete and all the pods to be running and healthy.You can carry on watching the deployments with `get pods -A` and `get helmreleases -A`.


